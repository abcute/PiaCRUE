{% extends "base.html" %}
{% block title %}Prompt Dashboard - PiaPES{% endblock %}

{% block content %}
    <h1>Prompt Dashboard</h1>
    <p><a href="{{ url_for('route_create_prompt_view') }}">Create New Prompt</a></p>
    <h2>Available Prompts:</h2>
    <ul id="prompt-list">
        <!-- Prompts will be loaded here by JavaScript -->
        <li>Loading prompts...</li>
    </ul>

    <h2>Available Curricula:</h2>
    <ul id="curriculum-list">
        <li>Loading curricula...</li>
    </ul>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Fetch Prompts
            fetch("{{ url_for('api_list_prompts') }}")
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const ul = document.getElementById('prompt-list');
                    ul.innerHTML = ''; // Clear loading message

                    if (data && data.length > 0) {
                        data.forEach(prompt_file_info => {
                            const filename = prompt_file_info.filename; // Assuming API returns objects with filename key
                            const name = prompt_file_info.name || filename; // Use name if available, else filename
                            const version = prompt_file_info.version || 'N/A';

                            const li = document.createElement('li');
                            li.innerHTML = `
                                <strong>${name}</strong> (Version: ${version})<br>
                                <small>File: ${filename}</small><br>
                                <a href="{{ url_for('route_view_prompt', filename='TEMP_FILENAME') }}".replace('TEMP_FILENAME', filename)>View/Render</a> |
                                <a href="{{ url_for('route_edit_prompt_view', filename='TEMP_FILENAME') }}".replace('TEMP_FILENAME', filename)>Edit</a> |
                                <button class="delete-btn" data-filename="${filename}">Delete</button>
                            `;
                            ul.appendChild(li);
                        });
                    } else {
                        ul.innerHTML = '<li>No prompts found in the data directory.</li>';
                    }

                    // Add event listeners for delete buttons
                    document.querySelectorAll('.delete-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            const filenameToDelete = this.dataset.filename;
                            if (confirm(`Are you sure you want to delete ${filenameToDelete}?`)) {
                                fetch("{{ url_for('api_delete_prompt', filename='TEMP_FILENAME') }}".replace('TEMP_FILENAME', filenameToDelete), {
                                    method: 'DELETE',
                                })
                                .then(response => {
                                    if (!response.ok) {
                                        return response.json().then(err => {throw new Error(err.error || `HTTP error! status: ${response.status}`)});
                                    }
                                    return response.json();
                                })
                                .then(result => {
                                    alert(result.message);
                                    // Refresh the list or remove the item from DOM
                                    window.location.reload();
                                })
                                .catch(error => {
                                    alert(`Error deleting prompt: ${error.message}`);
                                    console.error('Error deleting prompt:', error);
                                });
                            }
                        });
                    });
                })
                .catch(error => {
                    const ul = document.getElementById('prompt-list');
                    ul.innerHTML = `<li>Error loading prompts: ${error.message}. Please ensure the backend is running and accessible.</li>`;
                    console.error('Error fetching prompts:', error);
                });

            // Fetch Curricula
            fetch("{{ url_for('api_list_curricula') }}")
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const ul = document.getElementById('curriculum-list');
                    ul.innerHTML = ''; // Clear loading message

                    if (data && data.length > 0) {
                        data.forEach(curriculum_info => {
                            const filename = curriculum_info.filename;
                            const name = curriculum_info.name || filename;
                            const version = curriculum_info.version || 'N/A';

                            const li = document.createElement('li');
                            li.innerHTML = `
                                <strong>${name}</strong> (Version: ${version})<br>
                                <small>File: ${filename}</small><br>
                                <a href="{{ url_for('route_view_curriculum', filename='TEMP_FILENAME') }}".replace('TEMP_FILENAME', filename)>View Details</a>
                            `; // Note: No edit/delete for curricula in this MVP
                            ul.appendChild(li);
                        });
                    } else {
                        ul.innerHTML = '<li>No curricula found in the data directory.</li>';
                    }
                })
                .catch(error => {
                    const ul = document.getElementById('curriculum-list');
                    ul.innerHTML = `<li>Error loading curricula: ${error.message}. Please ensure the backend is running and accessible.</li>`;
                    console.error('Error fetching curricula:', error);
                });
        });
    </script>
{% endblock %}
