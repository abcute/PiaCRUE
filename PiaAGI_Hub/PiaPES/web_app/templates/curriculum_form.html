{% extends "base.html" %}
{% block title %}{{ form_title|default('Curriculum Form') }} - PiaPES{% endblock %}

{% block content %}
    <h1>{{ form_title|default('Curriculum Form') }}</h1>
    <form id="curriculumForm">
        <input type="hidden" id="form_mode" name="form_mode" value="{{ form_mode|default('create') }}">
        <input type="hidden" id="current_filename" name="current_filename" value="{{ current_filename|default('') }}">

        <div>
            <label for="filename">Filename (must end with .curriculum.json):</label>
            <input type="text" id="filename" name="filename" value="{{ curriculum_data.filename if curriculum_data else '' }}" required {% if form_mode == 'edit' %}readonly{% endif %}>
            {% if form_mode == 'edit' %}<small>Filename cannot be changed during edit.</small>{% endif %}
        </div>

        <div>
            <label for="name">Curriculum Name:</label>
            <input type="text" id="name" name="name" value="{{ curriculum_data.name if curriculum_data else '' }}" required>
        </div>

        <div>
            <label for="description">Description:</label>
            <textarea id="description" name="description" rows="3">{{ curriculum_data.description if curriculum_data else '' }}</textarea>
        </div>

        <div>
            <label for="target_developmental_stage">Target Developmental Stage:</label>
            <input type="text" id="target_developmental_stage" name="target_developmental_stage" value="{{ curriculum_data.target_developmental_stage if curriculum_data else '' }}">
        </div>

        <div>
            <label for="version">Version:</label>
            <input type="text" id="version" name="version" value="{{ curriculum_data.version if curriculum_data else '' }}">
        </div>

        <div>
            <label for="author">Author:</label>
            <input type="text" id="author" name="author" value="{{ curriculum_data.author if curriculum_data else '' }}">
        </div>

        <hr>
        <h2>Curriculum Steps</h2>
        {% if form_mode == 'create' %}
            <div id="steps-container">
                <!-- Steps will be added here by JavaScript -->
            </div>
            <button type="button" id="addStepButton">Add Curriculum Step</button>
        {% else %} {# edit mode #}
            <p><small>(Step editing is not available in this metadata editing mode. Steps will be preserved as they are.)</small></p>
            <!-- Optionally, display read-only steps if curriculum_data.steps is passed -->
            {% if curriculum_data and curriculum_data.steps %}
                <h4>Existing Steps (Read-Only):</h4>
                <ul>
                {% for step in curriculum_data.steps %}
                    <li>
                        <strong>Step {{ step.order }}: {{ step.name }}</strong><br>
                        Prompt: {{ step.prompt_reference }}<br>
                        Conditions: {{ step.conditions|default('N/A') }}<br>
                        Notes: {{ step.notes|default('N/A') }}
                    </li>
                {% endfor %}
                </ul>
            {% endif %}
        {% endif %}

        <hr style="margin-top: 20px;">
        <button type="submit">Save Curriculum</button>
    </form>
    <div id="error-message" class="error" style="margin-top: 15px;"></div>
    <div id="success-message" class="success" style="margin-top: 15px;"></div>

    <script>
        const curriculumForm = document.getElementById('curriculumForm');
        const stepsContainer = document.getElementById('steps-container');
        const addStepButton = document.getElementById('addStepButton'); // Might be null in edit mode
        const errorMessageDiv = document.getElementById('error-message');
        const successMessageDiv = document.getElementById('success-message');
        const formMode = document.getElementById('form_mode').value;
        const currentFilename = document.getElementById('current_filename').value; // Original filename for PUT URL
        let stepCounter = 0;

        if (formMode === 'edit' && currentFilename) {
            // Fetch and populate form for editing metadata
            // Filename field is already populated by Jinja and set to readonly
            // Other metadata fields (name, description, etc.) are also populated by Jinja.
            // No need to fetch again if Jinja has already populated curriculum_data correctly.
            // If curriculum_data was not fully passed, an API call would be needed here.
            // For now, assume Jinja passes necessary metadata.
            if (addStepButton) addStepButton.style.display = 'none'; // Hide add step button in edit mode
        }


        if (addStepButton) { // Only add event listener if the button exists (i.e., in 'create' mode)
            addStepButton.addEventListener('click', function() {
            stepCounter++;
            const stepDiv = document.createElement('fieldset');
            stepDiv.setAttribute('data-step-id', stepCounter);
            stepDiv.style.border = "1px solid #ccc";
            stepDiv.style.padding = "10px";
            stepDiv.style.marginBottom = "10px";

            stepDiv.innerHTML = `
                <legend>Step ${stepCounter}</legend>
                <div><label for="step_name_${stepCounter}">Step Name:</label>
                     <input type="text" id="step_name_${stepCounter}" name="step_name[]" required></div>
                <div><label for="step_order_${stepCounter}">Order:</label>
                     <input type="number" id="step_order_${stepCounter}" name="step_order[]" value="${stepCounter}" required></div>
                <div><label for="step_prompt_reference_${stepCounter}">Prompt Reference (filename, e.g., prompt.json):</label>
                     <input type="text" id="step_prompt_reference_${stepCounter}" name="step_prompt_reference[]" required></div>
                <div><label for="step_conditions_${stepCounter}">Conditions:</label>
                     <textarea id="step_conditions_${stepCounter}" name="step_conditions[]" rows="2"></textarea></div>
                <div><label for="step_notes_${stepCounter}">Notes:</label>
                     <textarea id="step_notes_${stepCounter}" name="step_notes[]" rows="2"></textarea></div>
                <button type="button" class="removeStepButton" style="background-color: #d9534f;">Remove This Step</button>
            `;
            stepsContainer.appendChild(stepDiv);

            stepDiv.querySelector('.removeStepButton').addEventListener('click', function() {
                stepDiv.remove();
                // Could re-number steps here if desired, but not critical for functionality
            });
        });

        curriculumForm.addEventListener('submit', function(event) {
            event.preventDefault();
            successMessageDiv.textContent = '';
            errorMessageDiv.textContent = '';

            const formData = new FormData(curriculumForm);
            const curriculumPayload = {
                "__type__": "DevelopmentalCurriculum",
                // filename for saving is handled by backend based on URL for PUT, or from payload for POST
                "name": formData.get('name'),
                "description": formData.get('description'),
                "target_developmental_stage": formData.get('target_developmental_stage'),
                "version": formData.get('version'),
                "author": formData.get('author')
                // Steps are only included for 'create' mode
            };

            let method;
            let url;

            if (formMode === 'edit') {
                method = 'PUT';
                url = "{{ url_for('api_update_curriculum_metadata', filename='TEMP_FILENAME') }}".replace('TEMP_FILENAME', currentFilename);
                // For PUT, we only send metadata, steps are not modified via this form.
                // Backend will preserve existing steps.
            } else { // 'create' mode
                method = 'POST';
                url = "{{ url_for('api_create_curriculum') }}";
                curriculumPayload.filename = formData.get('filename'); // Send filename for creation
                if (!curriculumPayload.filename || !curriculumPayload.filename.endsWith('.curriculum.json')) {
                    errorMessageDiv.textContent = "Filename is required for new curriculum and must end with .curriculum.json";
                    return;
                }

                curriculumPayload.steps = [];
                const stepElements = stepsContainer.querySelectorAll('fieldset[data-step-id]');
                stepElements.forEach(stepDiv => {
                    const stepName = stepDiv.querySelector('input[name="step_name[]"]').value;
                    const stepOrder = parseInt(stepDiv.querySelector('input[name="step_order[]"]').value, 10);
                    const stepPromptRef = stepDiv.querySelector('input[name="step_prompt_reference[]"]').value;
                    const stepConditions = stepDiv.querySelector('textarea[name="step_conditions[]"]').value;
                    const stepNotes = stepDiv.querySelector('textarea[name="step_notes[]"]').value;

                    if (stepName && !isNaN(stepOrder) && stepPromptRef) {
                        curriculumPayload.steps.push({
                            "__type__": "CurriculumStep",
                            "name": stepName,
                            "order": stepOrder,
                            "prompt_reference": stepPromptRef,
                            "conditions": stepConditions,
                            "notes": stepNotes
                        });
                    }
                });
                curriculumPayload.steps.sort((a, b) => a.order - b.order);
            }

            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(curriculumPayload)
            })
            .then(response => {
                const status = response.status;
                return response.json().then(data => ({ status, data }));
            })
            .then(result => {
                if (result.status < 200 || result.status >= 300) {
                    throw new Error(result.data.error || `HTTP error! status: ${result.status}`);
                }
                successMessageDiv.textContent = result.data.message || 'Curriculum action successful!';

                if (formMode === 'create' && result.data.filename) {
                     successMessageDiv.textContent += " Redirecting to view...";
                     setTimeout(() => {
                        window.location.href = "{{ url_for('route_view_curriculum', filename='TEMP_FILENAME') }}".replace('TEMP_FILENAME', result.data.filename);
                     }, 1500);
                } else if (formMode === 'edit') {
                    // Optionally, you could redirect to the view page or dashboard
                    // For now, just show success message. User can navigate away.
                    // Or, to see changes reflected if not redirecting:
                    // setTimeout(() => { window.location.reload(); }, 1000); // Or just let them stay
                } else { // Create mode but maybe no filename in response (should not happen with current backend)
                    curriculumForm.reset();
                    if(stepsContainer) stepsContainer.innerHTML = '';
                    stepCounter = 0;
                }
            })
            .catch(error => {
                errorMessageDiv.textContent = `Error saving curriculum: ${error.message}`;
                console.error('Error saving curriculum:', error);
            });
        });
    </script>
{% endblock %}
