{% extends "base.html" %}

{% block title %}View Curriculum: {{ curriculum.name if curriculum else filename }}{% endblock %}

{% block content %}
    <h1>Curriculum: {{ curriculum.name if curriculum else filename }}</h1>
    <p><a href="{{ url_for('route_dashboard') }}">Back to Dashboard</a></p>

    {% if curriculum %}
    <div id="curriculum-details">
        <h2>Details:</h2>
        <p><strong>Name:</strong> {{ curriculum.name }}</p>
        <p><strong>Description:</strong> {{ curriculum.description }}</p>
        <p><strong>Target Developmental Stage:</strong> {{ curriculum.target_developmental_stage }}</p>
        <p><strong>Version:</strong> {{ curriculum.version|default('N/A') }}</p>
        <p><strong>Author:</strong> {{ curriculum.author|default('N/A') }}</p>

        <h2>Steps:</h2>
        <div id="curriculum-steps-list">
        {% if curriculum.steps and curriculum.steps|length > 0 %}
            <ul>
            {% for step in curriculum.steps %}
                <li>
                    <h3>Step {{ step.order }}: {{ step.name }}</h3>
                    <p><strong>Prompt Reference:</strong>
                        <a href="{{ url_for('route_view_prompt', filename=step.prompt_reference) }}">{{ step.prompt_reference }}</a>
                    </p>
                    <p><strong>Conditions:</strong> {{ step.conditions|default('N/A') }}</p>
                    <p><strong>Notes:</strong> {{ step.notes|default('N/A') }}</p>
                </li>
            {% endfor %}
            </ul>
        {% else %}
            <p>No steps defined for this curriculum.</p>
        {% endif %}
        </div> {# end #curriculum-steps-list #}
    </div>
    <hr>
    <h2>Rendered Markdown Output:</h2>
    <pre id="rendered-markdown">Loading rendered output...</pre>

    <hr>
    <h2>Raw JSON Data:</h2>
    <pre id="raw-json">Loading raw data...</pre>

    {% else %}
        <p class="error">Curriculum data could not be loaded by the server for direct rendering.</p>
        <p class.="error">Attempting to load via API for raw JSON and Markdown.</p>
        <hr>
        <h2>Rendered Markdown Output:</h2>
        <pre id="rendered-markdown">Loading rendered output...</pre>

        <hr>
        <h2>Raw JSON Data:</h2>
        <pre id="raw-json">Loading raw data...</pre>
    {% endif %}


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const currentFilename = "{{ filename }}";
            const rawJsonPre = document.getElementById('raw-json');
            const renderedMarkdownPre = document.getElementById('rendered-markdown');

            // Fetch and display raw JSON data of the curriculum
            fetch("{{ url_for('api_get_curriculum', filename=filename) }}")
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status} for raw data`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.curriculum_data) {
                        rawJsonPre.textContent = JSON.stringify(data.curriculum_data, null, 2);
                        // If curriculum object was not passed by server, populate details here
                        if (!document.getElementById('curriculum-details')) {
                            populateCurriculumDetails(data.curriculum_data);
                        }
                    } else {
                         throw new Error("Invalid data structure for raw curriculum data.");
                    }
                })
                .catch(error => {
                    rawJsonPre.textContent = 'Error loading raw curriculum data: ' + error.message;
                    console.error('Error fetching raw curriculum data:', error);
                });

            // Fetch and display rendered Markdown
            fetch("{{ url_for('api_render_curriculum', filename=filename) }}")
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status} for rendered markdown`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.markdown) {
                        renderedMarkdownPre.textContent = data.markdown;
                    } else if (data.error) {
                        throw new Error(data.error);
                    } else {
                        throw new Error("Unexpected response format for rendered markdown.");
                    }
                })
                .catch(error => {
                    renderedMarkdownPre.textContent = 'Error loading rendered Markdown: ' + error.message;
                    console.error('Error fetching rendered markdown:', error);
                });

            // Function to populate details if not server-rendered (optional enhancement)
            function populateCurriculumDetails(data) {
                const container = document.getElementById('prompt-details-container') || document.body; // Fallback if structure isn't there
                if (document.getElementById('curriculum-details')) return; // Already populated by server

                let detailsHtml = `<h1>Curriculum: ${data.name || currentFilename}</h1>`;
                detailsHtml += `<p><a href="{{ url_for('route_dashboard') }}">Back to Dashboard</a></p>`;
                detailsHtml += `<div id="curriculum-details"><h2>Details:</h2>`;
                detailsHtml += `<p><strong>Name:</strong> ${data.name || 'N/A'}</p>`;
                detailsHtml += `<p><strong>Description:</strong> ${data.description || 'N/A'}</p>`;
                detailsHtml += `<p><strong>Target Developmental Stage:</strong> ${data.target_developmental_stage || 'N/A'}</p>`;
                detailsHtml += `<p><strong>Version:</strong> ${data.version || 'N/A'}</p>`;
                detailsHtml += `<p><strong>Author:</strong> ${data.author || 'N/A'}</p>`;
                detailsHtml += `<h2>Steps:</h2>`;
                detailsHtml += `<div id="curriculum-steps-list">`; // Match the server-side ID for consistent styling

                if (data.steps && data.steps.length > 0) {
                    detailsHtml += `<ul>`;
                    data.steps.forEach(step => {
                        detailsHtml += `<li>
                            <h3>Step ${step.order}: ${step.name}</h3>
                            <p><strong>Prompt Reference:</strong>
                                <a href="{{ url_for('route_view_prompt', filename='TEMP_FILENAME') }}".replace('TEMP_FILENAME', step.prompt_reference)>${step.prompt_reference}</a>
                            </p>
                            <p><strong>Conditions:</strong> ${step.conditions || 'N/A'}</p>
                            <p><strong>Notes:</strong> ${step.notes || 'N/A'}</p>
                        </li>`;
                    });
                    detailsHtml += `</ul>`;
                } else {
                    detailsHtml += `<p>No steps defined for this curriculum.</p>`;
                }
                detailsHtml += `</div>`; // Closing curriculum-steps-list-js
                detailsHtml += `</div>`; // Closing curriculum-details

                // Find a place to insert this if the server didn't provide it
                const existingContent = container.innerHTML;
                const hrRendered = document.getElementById('rendered-markdown').previousElementSibling; // Find the HR before rendered
                if (hrRendered) {
                    hrRendered.insertAdjacentHTML('beforebegin', detailsHtml);
                } else {
                    // Fallback prepend
                    const mainContentArea = document.querySelector('main.container') || document.body;
                    mainContentArea.insertAdjacentHTML('afterbegin', detailsHtml);
                }
            }
        });
    </script>
{% endblock %}
