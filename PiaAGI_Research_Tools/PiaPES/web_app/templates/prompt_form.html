{% extends "base.html" %}
{% block title %}{{ form_title|default('Prompt Form') }} - PiaPES{% endblock %}

{% block content %}
    <h1>{{ form_title|default('Prompt Form') }}</h1>

    {% if form_mode == 'create' or not current_prompt_filename_for_edit %} {# Show only in create mode effectively #}
    <fieldset id="load-template-fieldset">
        <legend>Load from Template (Optional)</legend>
        <div>
            <label for="loadTemplateSelect">Select Template to Load:</label>
            <select id="loadTemplateSelect" name="loadTemplateSelect">
                <option value="">-- Select a template --</option>
            </select>
            <button type="button" id="loadTemplateButton" class="action-button" style="background-color: #3498db; margin-left: 10px;">Load Template</button>
        </div>
    </fieldset>
    {% endif %}

    <form id="promptForm">
        <fieldset>
            <legend>Basic Information</legend>
            <input type="hidden" id="original_filename" name="original_filename" value="{{ prompt_data.filename if prompt_data and prompt_data.filename else (current_prompt_filename_for_edit if current_prompt_filename_for_edit else '') }}">
            <div>
                <label for="filename">Filename (must end with .json):</label>
                <input type="text" id="filename" name="filename" value="{{ prompt_data.filename if prompt_data and prompt_data.filename else (current_prompt_filename_for_edit if current_prompt_filename_for_edit else '') }}" required {% if form_mode == 'edit' %}readonly{% endif %}>
                <small>{% if form_mode == 'edit' %}Filename cannot be changed during edit. To "Save As" new, use the 'Save as New Template' button after making changes and setting a new filename (if desired, otherwise it will prompt or use a derived name).{% else %}This will be the name of the new file.{% endif %}</small>
            </div>
            <div><label for="author">Author:</label><input type="text" id="author" name="author" value="{{ prompt_data.author if prompt_data else '' }}"></div>
            <div><label for="version">Version:</label><input type="text" id="version" name="version" value="{{ prompt_data.version if prompt_data else '' }}"></div>
            <div><label for="objective">Objective:</label><textarea id="objective" name="objective" rows="3">{{ prompt_data.objective if prompt_data else '' }}</textarea></div>
            <div><label for="target_agi">Target AGI:</label><input type="text" id="target_agi" name="target_agi" value="{{ prompt_data.target_agi if prompt_data else '' }}"></div>
            <div><label for="developmental_stage_target">Developmental Stage Target:</label><input type="text" id="developmental_stage_target" name="developmental_stage_target" value="{{ prompt_data.developmental_stage_target if prompt_data else '' }}"></div>
            <div><label for="date">Date:</label><input type="text" id="date" name="date" value="{{ prompt_data.date if prompt_data else '' }}" placeholder="YYYY-MM-DD"></div>
        </fieldset>

        <fieldset>
            <legend>System Rules</legend>
            <div><label for="system_rules_language">Language:</label><input type="text" id="system_rules_language" name="system_rules_language" value="{{ prompt_data.system_rules_language if prompt_data else 'English' }}"></div>
            <div><label for="system_rules_output_format">Output Format:</label><input type="text" id="system_rules_output_format" name="system_rules_output_format" value="{{ prompt_data.system_rules_output_format if prompt_data else 'Natural language' }}"></div>
            <div><label for="system_rules_json">Advanced System Rules JSON (Supplements/overrides specific fields):</label><textarea id="system_rules_json" name="system_rules_json" rows="3" placeholder='{"__type__": "SystemRules", ...}'>{{ prompt_data.system_rules_json if prompt_data else '' }}</textarea></div>
        </fieldset>

        <fieldset>
            <legend>Requirements</legend>
            <div><label for="requirements_goal">Goal:</label><textarea id="requirements_goal" name="requirements_goal" rows="3">{{ prompt_data.requirements_goal if prompt_data else '' }}</textarea></div>
            <div><label for="requirements_background_context">Background Context:</label><textarea id="requirements_background_context" name="requirements_background_context" rows="3">{{ prompt_data.requirements_background_context if prompt_data else '' }}</textarea></div>
            <div><label for="requirements_json">Advanced Requirements JSON (Supplements/overrides specific fields):</label><textarea id="requirements_json" name="requirements_json" rows="3" placeholder='{"__type__": "Requirements", ...}'>{{ prompt_data.requirements_json if prompt_data else '' }}</textarea></div>
        </fieldset>

        <fieldset>
            <legend>Users/Interactors</legend>
            <div><label for="users_interactors_json">Users/Interactors (JSON):</label><textarea id="users_interactors_json" name="users_interactors_json" rows="3" placeholder='{"__type__": "UsersInteractors", ...}'>{{ prompt_data.users_interactors_json if prompt_data else '' }}</textarea></div>
        </fieldset>

        <fieldset>
            <legend>Executor Role Details</legend>
            <div><label for="role_name">Role Name:</label><input type="text" id="role_name" name="role_name" value="{{ prompt_data.role_name if prompt_data else 'DefaultRole' }}"></div>
            <div><label for="role_profile">Role Profile:</label><textarea id="role_profile" name="role_profile" rows="3">{{ prompt_data.role_profile if prompt_data else '' }}</textarea></div>
            <div><label for="role_skills_focus">Role Skills Focus (comma-separated):</label><input type="text" id="role_skills_focus" name="role_skills_focus" value="{{ prompt_data.role_skills_focus_str if prompt_data else '' }}"></div>
            <div><label for="role_knowledge_domains_active">Role Knowledge Domains Active (comma-separated):</label><input type="text" id="role_knowledge_domains_active" name="role_knowledge_domains_active" value="{{ prompt_data.role_knowledge_domains_active_str if prompt_data else '' }}"></div>
            <div><label for="executors_json">Advanced Executors JSON (Supplements/overrides specific Role fields; Cognitive Config is separate):</label><textarea id="executors_json" name="executors_json" rows="4" placeholder='{"__type__": "Executors", "role": {"__type__": "Role", ...}}'>{{ prompt_data.executors_json if prompt_data else '' }}</textarea></div>
        </fieldset>

        <fieldset>
            <legend>Cognitive Module Configuration (within the Role)</legend>
            <fieldset><legend>Personality (OCEAN Scores)</legend>
                <div><label for="personality_openness">Openness (0.0-1.0):</label><input type="number" id="personality_openness" name="personality_openness" min="0" max="1" step="0.01" value="{{ prompt_data.personality_openness if prompt_data else '' }}"></div>
                <div><label for="personality_conscientiousness">Conscientiousness (0.0-1.0):</label><input type="number" id="personality_conscientiousness" name="personality_conscientiousness" min="0" max="1" step="0.01" value="{{ prompt_data.personality_conscientiousness if prompt_data else '' }}"></div>
                <div><label for="personality_extraversion">Extraversion (0.0-1.0):</label><input type="number" id="personality_extraversion" name="personality_extraversion" min="0" max="1" step="0.01" value="{{ prompt_data.personality_extraversion if prompt_data else '' }}"></div>
                <div><label for="personality_agreeableness">Agreeableness (0.0-1.0):</label><input type="number" id="personality_agreeableness" name="personality_agreeableness" min="0" max="1" step="0.01" value="{{ prompt_data.personality_agreeableness if prompt_data else '' }}"></div>
                <div><label for="personality_neuroticism">Neuroticism (0.0-1.0):</label><input type="number" id="personality_neuroticism" name="personality_neuroticism" min="0" max="1" step="0.01" value="{{ prompt_data.personality_neuroticism if prompt_data else '' }}"></div>
            </fieldset>
            <fieldset><legend>Motivational Biases</legend>
                <div><label for="motivational_biases_text">Biases (comma-separated key:value pairs):</label><textarea id="motivational_biases_text" name="motivational_biases_text" rows="3">{{ prompt_data.motivational_biases_text if prompt_data else '' }}</textarea></div>
            </fieldset>
            <fieldset><legend>Emotional Profile</legend>
                <div><label for="emotional_baseline_valence">Baseline Valence:</label><input type="text" id="emotional_baseline_valence" name="emotional_baseline_valence" value="{{ prompt_data.emotional_baseline_valence if prompt_data else '' }}"></div>
                <div><label for="emotional_reactivity_to_failure">Reactivity to Failure Intensity:</label><input type="text" id="emotional_reactivity_to_failure" name="emotional_reactivity_to_failure" value="{{ prompt_data.emotional_reactivity_to_failure if prompt_data else '' }}"></div>
                <div><label for="emotional_empathy_target">Empathy Level Target:</label><input type="text" id="emotional_empathy_target" name="emotional_empathy_target" value="{{ prompt_data.emotional_empathy_target if prompt_data else '' }}"></div>
            </fieldset>
            <fieldset><legend>Learning Module Config</legend>
                <div><label for="learning_primary_mode">Primary Learning Mode:</label><input type="text" id="learning_primary_mode" name="learning_primary_mode" value="{{ prompt_data.learning_primary_mode if prompt_data else '' }}"></div>
                <div><label for="learning_rate_adaptation_enabled">Learning Rate Adaptation Enabled:</label><input type="checkbox" id="learning_rate_adaptation_enabled" name="learning_rate_adaptation_enabled" value="true" {% if prompt_data and prompt_data.learning_rate_adaptation_enabled %}checked{% endif %}></div>
            </fieldset>
        </fieldset>

        <fieldset>
            <legend>Workflow Steps</legend>
            <div id="workflow-steps-container"></div>
            <button type="button" id="addWorkflowStepButton" class="action-button" style="background-color: #2ecc71; margin-bottom:10px;">Add Workflow Step</button>
            <div><label for="workflow_or_curriculum_phase_json">Advanced Workflow JSON (If UI steps added, they override 'steps' here):</label><textarea id="workflow_or_curriculum_phase_json" name="workflow_or_curriculum_phase_json" rows="3" placeholder='{"__type__": "Workflow", "steps": [...]}'>{{ prompt_data.workflow_or_curriculum_phase_json if prompt_data else '' }}</textarea></div>
        </fieldset>

        <fieldset>
            <legend>Developmental Scaffolding Context</legend>
            <div><label for="dev_scaffolding_current_developmental_goal">Current Developmental Goal:</label><textarea id="dev_scaffolding_current_developmental_goal" name="dev_scaffolding_current_developmental_goal" rows="2">{{ prompt_data.dev_scaffolding_current_developmental_goal if prompt_data else '' }}</textarea></div>
            <div><label for="dev_scaffolding_techniques_employed">Techniques Employed (comma-separated):</label><input type="text" id="dev_scaffolding_techniques_employed" name="dev_scaffolding_techniques_employed" value="{{ prompt_data.dev_scaffolding_techniques_employed_str if prompt_data else '' }}"></div>
            <div><label for="dev_scaffolding_feedback_level">Feedback Level from Overseer:</label><input type="text" id="dev_scaffolding_feedback_level" name="dev_scaffolding_feedback_level" value="{{ prompt_data.dev_scaffolding_feedback_level if prompt_data else '' }}"></div>
            <div><label for="developmental_scaffolding_context_json">Advanced Dev. Scaffolding JSON (Supplements/overrides specific fields):</label><textarea id="developmental_scaffolding_context_json" name="developmental_scaffolding_context_json" rows="3" placeholder='{"__type__": "DevelopmentalScaffolding", ...}'>{{ prompt_data.developmental_scaffolding_context_json if prompt_data else '' }}</textarea></div>
        </fieldset>

        <fieldset>
            <legend>Other Core Prompt Sections (JSON)</legend>
            <div><label for="cbt_autotraining_protocol_json">CBT AutoTraining Protocol (JSON):</label><textarea id="cbt_autotraining_protocol_json" name="cbt_autotraining_protocol_json" rows="4" placeholder='{"__type__": "CBTAutoTraining", ...}'>{{ prompt_data.cbt_autotraining_protocol_json if prompt_data else '' }}</textarea></div>
        </fieldset>

        <div><label for="initiate_interaction">Initiate Interaction:</label><textarea id="initiate_interaction" name="initiate_interaction" rows="3">{{ prompt_data.initiate_interaction if prompt_data else '' }}</textarea></div>

        <button type="submit">Save Prompt</button>
        <button type="button" id="saveAsNewTemplateButton" class="action-button" style="background-color: #e67e22; margin-left:10px;">Save as New Template</button>
    </form>
    <div id="error-message" class="error" style="margin-top: 15px;"></div>
    <div id="success-message" class="success" style="margin-top: 15px;"></div>

    <script>
        // Constants for form elements
        const promptForm = document.getElementById('promptForm');
        const originalFilenameField = document.getElementById('original_filename');
        const filenameField = document.getElementById('filename');
        const errorMessageDiv = document.getElementById('error-message');
        const successMessageDiv = document.getElementById('success-message');
        const formMode = "{{ form_mode|default('create') }}";
        const currentPromptFilenameForEdit = "{{ prompt_filename_for_edit if prompt_filename_for_edit else '' }}";

        const workflowStepsContainer = document.getElementById('workflow-steps-container');
        const addWorkflowStepButton = document.getElementById('addWorkflowStepButton');
        let wfStepCounter = 0;
        let availablePrompts = [];

        // --- Helper Functions ---
        function parseJsonField(formData, fieldName, defaultType = null) {
            const jsonString = formData.get(fieldName + '_json'); // Ensure your textareas have name="<fieldName>_json"
            let parsedJson = null;
            if (jsonString && jsonString.trim() !== "") {
                try { parsedJson = JSON.parse(jsonString); }
                catch (e) { throw new Error(`Invalid JSON in ${fieldName}_json: ${e.message}`); }
            }
            if (defaultType && (!parsedJson || (typeof parsedJson === 'object' && !parsedJson.__type__ && defaultType))) {
                if (!parsedJson) parsedJson = {};
                parsedJson["__type__"] = defaultType;
            } else if (parsedJson && defaultType && parsedJson.__type__ !== defaultType) {
                // Allow if user provides a more specific type that inherits from defaultType (not checkable here)
                // console.warn(`JSON for ${fieldName} has __type__ ${parsedJson.__type__}, expected compatible with ${defaultType}. Using provided type.`);
            }
            return parsedJson;
        }

        function addWorkflowStepToForm(stepData = null) {
            wfStepCounter++;
            const stepDiv = document.createElement('fieldset');
            stepDiv.setAttribute('data-wf-step-id', wfStepCounter);
            stepDiv.className = 'workflow-step-item';
            stepDiv.innerHTML = `
                <legend>Workflow Step ${wfStepCounter}</legend>
                <input type="hidden" name="wf_step_order[]" value="${stepData?.order || wfStepCounter}">
                <div><label>Name: <input type="text" name="wf_step_name[]" value="${stepData?.name || ''}" required></label></div>
                <div><label>Action Directive: <textarea name="wf_step_action_directive[]" rows="2">${stepData?.action_directive || ''}</textarea></label></div>
                <div><label>Module Focus (comma-separated): <input type="text" name="wf_step_module_focus[]" value="${stepData?.module_focus ? (Array.isArray(stepData.module_focus) ? stepData.module_focus.join(', ') : stepData.module_focus) : ''}"></label></div>
                <div><label>Expected Internal Outcome: <textarea name="wf_step_expected_outcome_internal[]" rows="2">${stepData?.expected_outcome_internal || ''}</textarea></label></div>
                <div><label>Expected External Output: <textarea name="wf_step_expected_output_external[]" rows="2">${stepData?.expected_output_external || ''}</textarea></label></div>
                <button type="button" class="removeStepButton">Remove Step</button>
            `;
            workflowStepsContainer.appendChild(stepDiv);
            stepDiv.querySelector('.removeStepButton').addEventListener('click', () => stepDiv.remove());
        }

        function populateFormWithData(dataToLoad, isTemplateLoad = false) {
            if (!dataToLoad) return;

            if (isTemplateLoad) {
                filenameField.value = `copy_of_${dataToLoad.filename || 'template'}.json`.replace(".json.json", ".json");
                originalFilenameField.value = ""; // It's a new prompt
                 // Clear version or suggest new one
                document.getElementById('version').value = (dataToLoad.version ? dataToLoad.version + "-copy" : "1.0");
            } else { // Editing existing
                filenameField.value = currentPromptFilenameForEdit;
                originalFilenameField.value = currentPromptFilenameForEdit;
                document.getElementById('version').value = dataToLoad.version || '';
            }

            ['author', 'objective', 'target_agi', 'developmental_stage_target', 'date', 'initiate_interaction'].forEach(key => {
                document.getElementById(key).value = dataToLoad[key] || '';
            });

            const sr = dataToLoad.system_rules || {};
            document.getElementById('system_rules_language').value = sr.language || 'English';
            document.getElementById('system_rules_output_format').value = sr.output_format || 'Natural language';
            document.getElementById('system_rules_json').value = dataToLoad.system_rules ? JSON.stringify(sr, null, 2) : '';

            const rq = dataToLoad.requirements || {};
            document.getElementById('requirements_goal').value = rq.goal || '';
            document.getElementById('requirements_background_context').value = rq.background_context || '';
            document.getElementById('requirements_json').value = dataToLoad.requirements ? JSON.stringify(rq, null, 2) : '';

            document.getElementById('users_interactors_json').value = dataToLoad.users_interactors ? JSON.stringify(dataToLoad.users_interactors, null, 2) : '';
            document.getElementById('cbt_autotraining_protocol_json').value = dataToLoad.cbt_autotraining_protocol ? JSON.stringify(dataToLoad.cbt_autotraining_protocol, null, 2) : '';

            const ex = dataToLoad.executors || {};
            const role = ex.role || {};
            document.getElementById('role_name').value = role.name || (formMode === 'create' && !isTemplateLoad ? 'DefaultRole' : '');
            document.getElementById('role_profile').value = role.profile || '';
            document.getElementById('role_skills_focus').value = Array.isArray(role.skills_focus) ? role.skills_focus.join(', ') : '';
            document.getElementById('role_knowledge_domains_active').value = Array.isArray(role.knowledge_domains_active) ? role.knowledge_domains_active.join(', ') : '';

            let exCopy = dataToLoad.executors ? JSON.parse(JSON.stringify(dataToLoad.executors)) : null;
            if (exCopy && exCopy.role) {
                delete exCopy.role.cognitive_module_configuration;
                delete exCopy.role.name; delete exCopy.role.profile;
                delete exCopy.role.skills_focus; delete exCopy.role.knowledge_domains_active;
            }
            document.getElementById('executors_json').value = exCopy ? JSON.stringify(exCopy, null, 2) : '';

            const cmc = role.cognitive_module_configuration || {};
            const pc = cmc.personality_config || {};
            ['openness', 'conscientiousness', 'extraversion', 'agreeableness', 'neuroticism'].forEach(trait => {
                document.getElementById(`personality_${trait}`).value = (pc[`ocean_${trait}`] !== null && pc[`ocean_${trait}`] !== undefined) ? pc[`ocean_${trait}`] : '';
            });
            const mb = cmc.motivational_bias_config || {};
            document.getElementById('motivational_biases_text').value = (mb.biases && Object.keys(mb.biases).length) ?
                Object.entries(mb.biases).map(([k,v]) => `${k}:${v}`).join(', ') : '';
            const ep = cmc.emotional_profile_config || {};
            document.getElementById('emotional_baseline_valence').value = ep.baseline_valence || '';
            document.getElementById('emotional_reactivity_to_failure').value = ep.reactivity_to_failure_intensity || '';
            document.getElementById('emotional_empathy_target').value = ep.empathy_level_target || '';
            const lc = cmc.learning_module_config || {};
            document.getElementById('learning_primary_mode').value = lc.primary_learning_mode || '';
            document.getElementById('learning_rate_adaptation_enabled').checked = !!lc.learning_rate_adaptation;

            workflowStepsContainer.innerHTML = '';
            wfStepCounter = 0;
            const wf = dataToLoad.workflow_or_curriculum_phase || {};
            if (wf.__type__ === 'Workflow' && Array.isArray(wf.steps)) {
                wf.steps.forEach(step => addWorkflowStepToForm(step));
            }
            document.getElementById('workflow_or_curriculum_phase_json').value = dataToLoad.workflow_or_curriculum_phase ? JSON.stringify(wf, null, 2) : '';

            const ds = dataToLoad.developmental_scaffolding_context || {};
            document.getElementById('dev_scaffolding_current_developmental_goal').value = ds.current_developmental_goal || '';
            document.getElementById('dev_scaffolding_techniques_employed').value = Array.isArray(ds.scaffolding_techniques_employed) ? ds.scaffolding_techniques_employed.join(', ') : '';
            document.getElementById('dev_scaffolding_feedback_level').value = ds.feedback_level_from_overseer || '';
            document.getElementById('developmental_scaffolding_context_json').value = dataToLoad.developmental_scaffolding_context ? JSON.stringify(ds, null, 2) : '';
        }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            const loadTemplateSelect = document.getElementById('loadTemplateSelect');
            if (loadTemplateSelect) {
                fetch("{{ url_for('api_list_prompts') }}")
                    .then(response => response.json())
                    .then(data => {
                        if(data && Array.isArray(data)) {
                            data.forEach(promptInfo => {
                                if (promptInfo.filename) {
                                    const option = document.createElement('option');
                                    option.value = promptInfo.filename;
                                    option.textContent = promptInfo.name ? `${promptInfo.name} (${promptInfo.filename})` : promptInfo.filename;
                                    loadTemplateSelect.appendChild(option);
                                }
                            });
                        }
                    }).catch(e => console.error("Failed to load templates for dropdown:", e));
            }

            const loadTemplateButton = document.getElementById('loadTemplateButton');
            if (loadTemplateButton) {
                loadTemplateButton.addEventListener('click', function() {
                    const selectedFile = loadTemplateSelect.value;
                    if (!selectedFile) { alert("Please select a template to load."); return; }
                    fetch(`{{ url_for('api_get_prompt', filename='TEMP_FILENAME') }}`.replace('TEMP_FILENAME', selectedFile))
                        .then(response => {
                            if (!response.ok) throw new Error(`Failed to load template: ${response.statusText}`);
                            return response.json();
                        })
                        .then(apiResponse => { // Renamed 'data' to 'apiResponse' to avoid conflict
                            if (apiResponse.prompt_data) {
                                populateFormWithData(apiResponse.prompt_data, true); // Pass true for isTemplateLoad
                                successMessageDiv.textContent = `Template '${selectedFile}' loaded. Please set a new filename.`;
                                errorMessageDiv.textContent = '';
                            } else { throw new Error("Loaded template data is not in the expected format."); }
                        })
                        .catch(error => {
                            errorMessageDiv.textContent = error.message;
                            console.error("Error loading template:", error);
                        });
                });
            }

            if (currentPromptFilenameForEdit) {
                 // Data is passed as `prompt_data` from Flask route `route_edit_prompt_view`
                 // and used by Jinja to pre-fill static fields.
                 // Dynamic parts like workflow steps need JS population.
                const workflowStepsData = {{ prompt_data.workflow_steps_data | tojson | safe if prompt_data and prompt_data.workflow_steps_data else 'null' }};
                if (workflowStepsData && Array.isArray(workflowStepsData)) {
                    workflowStepsData.forEach(step => addWorkflowStepToForm(step));
                }
            }

            if (addWorkflowStepButton) {
                addWorkflowStepButton.addEventListener('click', () => addWorkflowStepToForm());
            }
        });

        // --- Form Submission ---
        function handleFormSubmit(isSaveAsNew = false) {
            successMessageDiv.textContent = ''; errorMessageDiv.textContent = '';
            const formData = new FormData(promptForm);
            const fullPromptData = { "__type__": "PiaAGIPrompt" };

            ['target_agi', 'developmental_stage_target', 'author', 'version', 'date', 'objective', 'initiate_interaction'].forEach(key => {
                fullPromptData[key] = formData.get(key) || null;
            });

            try {
                let systemRulesData = parseJsonField(formData, 'system_rules', 'SystemRules');
                systemRulesData.language = formData.get('system_rules_language') || systemRulesData.language;
                systemRulesData.output_format = formData.get('system_rules_output_format') || systemRulesData.output_format;
                fullPromptData.system_rules = systemRulesData;

                let requirementsData = parseJsonField(formData, 'requirements', 'Requirements');
                requirementsData.goal = formData.get('requirements_goal') || requirementsData.goal;
                requirementsData.background_context = formData.get('requirements_background_context') || requirementsData.background_context;
                fullPromptData.requirements = requirementsData;

                let executorsData = parseJsonField(formData, 'executors', 'Executors');
                if (!executorsData.role || typeof executorsData.role !== 'object') {
                    executorsData.role = { "__type__": "Role", name: formData.get('role_name') || "DefaultRole" };
                } else if (!executorsData.role.__type__) {
                    executorsData.role.__type__ = "Role";
                }
                executorsData.role.name = formData.get('role_name') || executorsData.role.name;
                executorsData.role.profile = formData.get('role_profile') || executorsData.role.profile;
                const skillsFocusStr = formData.get('role_skills_focus').trim();
                executorsData.role.skills_focus = skillsFocusStr ? skillsFocusStr.split(',').map(s => s.trim()).filter(s => s) : (executorsData.role.skills_focus || []);
                const knowledgeDomainsStr = formData.get('role_knowledge_domains_active').trim();
                executorsData.role.knowledge_domains_active = knowledgeDomainsStr ? knowledgeDomainsStr.split(',').map(s => s.trim()).filter(s => s) : (executorsData.role.knowledge_domains_active || []);

                const personalityConfig = { "__type__": "PersonalityConfig" };
                ['openness', 'conscientiousness', 'extraversion', 'agreeableness', 'neuroticism'].forEach(trait => {
                    const val = formData.get(`personality_${trait}`);
                    personalityConfig[`ocean_${trait}`] = (val !== null && val !== "") ? parseFloat(val) : null;
                });
                const motivationalBiasesText = formData.get('motivational_biases_text');
                const motivationalBiases = {};
                if (motivationalBiasesText) {
                    motivationalBiasesText.split(',').forEach(pair => {
                        const parts = pair.split(':');
                        if (parts.length === 2) {
                            const key = parts[0].trim(); const value = parts[1].trim();
                            motivationalBiases[key] = isNaN(parseFloat(value)) ? value : parseFloat(value);
                        }
                    });
                }
                const motivationalBiasConfig = { "__type__": "MotivationalBias", "biases": motivationalBiases };
                const emotionalProfileConfig = { "__type__": "EmotionalProfile",
                    "baseline_valence": formData.get('emotional_baseline_valence') || null,
                    "reactivity_to_failure_intensity": formData.get('emotional_reactivity_to_failure') || null,
                    "empathy_level_target": formData.get('emotional_empathy_target') || null };
                const learningModuleConfig = { "__type__": "LearningModuleConfig",
                    "primary_learning_mode": formData.get('learning_primary_mode') || null,
                    "learning_rate_adaptation": formData.get('learning_rate_adaptation_enabled') === 'true' };
                executorsData.role.cognitive_module_configuration = { "__type__": "CognitiveModuleConfiguration",
                    "personality_config": personalityConfig, "motivational_bias_config": motivationalBiasConfig,
                    "emotional_profile_config": emotionalProfileConfig, "learning_module_config": learningModuleConfig };
                fullPromptData.executors = executorsData;

                let workflowDataFromUI = null;
                const wfStepElements = workflowStepsContainer.querySelectorAll('fieldset[data-wf-step-id]');
                if (wfStepElements.length > 0) {
                    let collectedWorkflowSteps = [];
                    wfStepElements.forEach(stepDiv => {
                        const stepName = stepDiv.querySelector('input[name="wf_step_name[]"]').value;
                        const moduleFocusStr = stepDiv.querySelector('input[name="wf_step_module_focus[]"]').value.trim();
                        if (stepName) {
                            collectedWorkflowSteps.push({ "__type__": "WorkflowStep", "name": stepName,
                                "action_directive": stepDiv.querySelector('textarea[name="wf_step_action_directive[]"]').value,
                                "module_focus": moduleFocusStr ? moduleFocusStr.split(',').map(s => s.trim()).filter(s => s) : [],
                                "expected_outcome_internal": stepDiv.querySelector('textarea[name="wf_step_expected_outcome_internal[]"]').value,
                                "expected_output_external": stepDiv.querySelector('textarea[name="wf_step_expected_output_external[]"]').value
                            });
                        }
                    });
                    if (collectedWorkflowSteps.length > 0) {
                        workflowDataFromUI = { "__type__": "Workflow", "steps": collectedWorkflowSteps };
                    }
                }
                if (workflowDataFromUI) { fullPromptData.workflow_or_curriculum_phase = workflowDataFromUI; }
                else { fullPromptData.workflow_or_curriculum_phase = parseJsonField(formData, 'workflow_or_curriculum_phase', 'Workflow'); }

                let devScaffoldingDataFromUI = null;
                const devGoal = formData.get('dev_scaffolding_current_developmental_goal').trim();
                const devTechniquesStr = formData.get('dev_scaffolding_techniques_employed').trim();
                const devFeedback = formData.get('dev_scaffolding_feedback_level').trim();
                if (devGoal || devTechniquesStr || devFeedback) {
                    devScaffoldingDataFromUI = { "__type__": "DevelopmentalScaffolding",
                        "current_developmental_goal": devGoal || null,
                        "scaffolding_techniques_employed": devTechniquesStr ? devTechniquesStr.split(',').map(s => s.trim()).filter(s => s) : [],
                        "feedback_level_from_overseer": devFeedback || null };
                }
                if (devScaffoldingDataFromUI) { fullPromptData.developmental_scaffolding_context = devScaffoldingDataFromUI; }
                else { fullPromptData.developmental_scaffolding_context = parseJsonField(formData, 'developmental_scaffolding_context', 'DevelopmentalScaffolding'); }

                ['users_interactors', 'cbt_autotraining_protocol'].forEach(fieldName => {
                    const defaultTypes = {'users_interactors': 'UsersInteractors', 'cbt_autotraining_protocol': 'CBTAutoTraining'};
                    fullPromptData[fieldName] = parseJsonField(formData, fieldName, defaultTypes[fieldName]);
                });

            } catch (e) {
                errorMessageDiv.textContent = `Error processing form data: ${e.message}`; return;
            }

            const targetFilename = filenameField.value.trim();
            if (!targetFilename.endsWith('.json')) {
                errorMessageDiv.textContent = "Filename must end with .json"; return;
            }

            let method = 'POST';
            let url = "{{ url_for('api_create_prompt') }}";
            fullPromptData.filename = targetFilename;

            if (formMode === 'edit' && currentPromptFilenameForEdit && !isSaveAsNew) {
                method = 'PUT';
                url = `{{ url_for('api_update_prompt', filename='TEMP_FILENAME') }}`.replace('TEMP_FILENAME', currentPromptFilenameForEdit);
                 // For PUT, filename is in URL. Ensure body data doesn't try to change filename implicitly via its own 'filename' key.
                if (fullPromptData.filename && fullPromptData.filename !== currentPromptFilenameForEdit) {
                    // This case should be prevented by readonly filename in edit mode, but as a safeguard:
                    console.warn("Filename in body differs from URL for PUT. Using URL filename.");
                    delete fullPromptData.filename;
                }
            }
            // If isSaveAsNew is true, method remains POST and uses targetFilename from form.
            if (isSaveAsNew && (!targetFilename || targetFilename === currentPromptFilenameForEdit)) {
                 errorMessageDiv.textContent = "For 'Save as New', please provide a new, unique filename in the 'Filename' field."; return;
            }

            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(fullPromptData)
            })
            .then(response => {
                const status = response.status;
                return response.json().then(data => ({ status, data }));
            })
            .then(result => {
                if (result.status < 200 || result.status >= 300) {
                    throw new Error(result.data.error || `HTTP error! status: ${result.status}`);
                }
                successMessageDiv.textContent = result.data.message || 'Prompt action successful!';

                if (method === 'POST' && result.data.filename) {
                    successMessageDiv.textContent += " Redirecting to edit...";
                    window.location.href = `{{ url_for('route_edit_prompt_view', filename='TEMP_FILENAME') }}`.replace('TEMP_FILENAME', result.data.filename);
                } else if (method === 'PUT') {
                    // For PUT success, optionally reload to show changes if any advanced JSON was also cleared by specific fields
                    // For now, just show message.
                }
            })
            .catch(error => {
                errorMessageDiv.textContent = `Error: ${error.message}`;
                console.error('Error saving/updating prompt:', error);
            });
        }

        promptForm.addEventListener('submit', function(event) {
            event.preventDefault();
            handleFormSubmit(false);
        });

        const saveAsNewButton = document.getElementById('saveAsNewTemplateButton');
        if (saveAsNewButton) {
            saveAsNewButton.addEventListener('click', function(event) {
                event.preventDefault();
                // When "Save as New", ensure filename is not readonly temporarily if it was,
                // or rely on user changing it before clicking.
                // Best to ensure filename field is editable for this action.
                if (filenameField.hasAttribute('readonly')) {
                    alert("Please change the filename in the 'Filename' field above to save as a new template.");
                    filenameField.focus();
                    return;
                }
                if (filenameField.value === currentPromptFilenameForEdit) {
                     alert("To 'Save as New Template', please enter a different filename than the original.");
                     filenameField.focus();
                     return;
                }
                handleFormSubmit(true);
            });
        }
    </script>
{% endblock %}
